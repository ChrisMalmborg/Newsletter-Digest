<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Newsletters</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 680px;
            margin: 40px auto;
            padding: 0 20px;
            color: #333;
            background: #f8f9fa;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }
        p.subtitle {
            color: #666;
            margin-bottom: 32px;
        }
        .section {
            margin-bottom: 36px;
        }
        .section h2 {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            margin-bottom: 4px;
        }
        .section-note {
            font-size: 13px;
            color: #999;
            margin: 0 0 12px;
        }
        .card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .card input[type="checkbox"] {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #4285f4;
        }
        .card .info {
            flex: 1;
            min-width: 0;
        }
        .card .sender-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card .sender-email {
            font-size: 13px;
            color: #666;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card .email-count {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
        .btn-dismiss {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .btn-dismiss:hover {
            background: #f3f4f6;
            color: #333;
        }
        .empty {
            color: #aaa;
            font-size: 14px;
            padding: 16px 0 4px;
        }
        .divider {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 32px 0;
        }
        .actions {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }
        .btn-save {
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-save:hover { background: #3367d6; }
        a.cancel {
            color: #666;
            font-size: 14px;
            text-decoration: none;
        }
        a.cancel:hover { color: #333; }
        .banner {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .banner.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .banner.error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .manual-add {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
            margin-top: 8px;
        }
        .manual-add .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .manual-add input[type="text"],
        .manual-add input[type="email"] {
            flex: 1;
            min-width: 0;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
        }
        .manual-add input[type="text"]:focus,
        .manual-add input[type="email"]:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66,133,244,0.15);
        }
        .btn-add-manual {
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-add-manual:hover { background: #3367d6; }
    </style>
</head>
<body>
    <h1>Manage Newsletters</h1>
    <p class="subtitle">Review your subscriptions and add new ones from your inbox.</p>

    {% if success %}
    <div class="banner success">{{ success }}</div>
    {% endif %}
    {% if error %}
    <div class="banner error">{{ error }}</div>
    {% endif %}

    {# The main save form — inputs use form="main-form" so they work outside this element #}
    <form id="main-form" method="post" action="/newsletters/save"></form>

    {# ── Section 1: Your Subscriptions ── #}
    <div class="section">
        <h2>Your Subscriptions</h2>
        {% if subscriptions %}
        <p class="section-note">Uncheck any you'd like to remove, then save.</p>
        {% for sub in subscriptions %}
        <div class="card">
            <input form="main-form" type="checkbox" name="keep_sub" value="{{ sub.id }}" checked>
            <input form="main-form" type="hidden" name="all_sub_ids" value="{{ sub.id }}">
            <div class="info">
                <div class="sender-name">{{ sub.sender_name }}</div>
                <div class="sender-email">{{ sub.sender_email }}</div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="empty">No subscriptions yet. Add some from the detected list below.</p>
        {% endif %}
    </div>

    <hr class="divider">

    {# ── Section 2: Detected Newsletters ── #}
    <div class="section">
        <h2>Detected in Inbox</h2>
        {% if detected %}
        <p class="section-note">Check any you'd like to subscribe to, then save. Dismiss to hide permanently.</p>
        {% for nl in detected %}
        <div class="card">
            <input form="main-form" type="checkbox" name="add_detected" value="{{ nl.sender_email }}">
            <input form="main-form" type="hidden" name="sender_name_{{ nl.sender_email }}" value="{{ nl.sender_name }}">
            <div class="info">
                <div class="sender-name">{{ nl.sender_name }}</div>
                <div class="sender-email">{{ nl.sender_email }}</div>
                {% if nl.email_count %}
                <div class="email-count">{{ nl.email_count }} email{{ "s" if nl.email_count != 1 else "" }} found</div>
                {% endif %}
            </div>
            <form method="post" action="/newsletters/dismiss">
                <input type="hidden" name="sender_email" value="{{ nl.sender_email }}">
                <button type="submit" class="btn-dismiss">Dismiss</button>
            </form>
        </div>
        {% endfor %}
        {% else %}
        <p class="empty">No new newsletters detected in your recent inbox.</p>
        {% endif %}
    </div>

    <hr class="divider">

    {# ── Section 3: Manual Add ── #}
    <div class="section">
        <h2>Add Manually</h2>
        <p class="section-note">Paste a sender email address to add it directly — useful for newsletters that weren't auto-detected.</p>
        <form method="post" action="/newsletters/add-manual" class="manual-add">
            <div class="row">
                <input type="email" name="manual_email" placeholder="sender@example.com" required>
                <input type="text" name="manual_name" placeholder="Display name (optional)">
                <button type="submit" class="btn-add-manual">Add</button>
            </div>
        </form>
    </div>

    <div class="actions">
        <button form="main-form" type="submit" class="btn-save">Save Changes</button>
        <a class="cancel" href="/dashboard">Cancel</a>
    </div>
</body>
</html>
